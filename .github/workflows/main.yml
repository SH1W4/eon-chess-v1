name: Aeon Chess CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Testes e ValidaÃ§Ã£o
  test:
    name: ğŸ§ª Testes e ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        
    - name: ğŸ“¦ Install Node.js dependencies
      run: npm ci
      
    - name: ğŸ” Lint Python code
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        black --check src/
        
    - name: ğŸ” Lint TypeScript/JavaScript
      run: |
        npm run lint
        npm run type-check
        
    - name: ğŸ§ª Run Python tests
      run: |
        pytest tests/ -v --cov=src --cov-report=xml
        
    - name: ğŸ§ª Run JavaScript tests
      run: |
        npm test -- --coverage --watchAll=false
        
    - name: ğŸ“Š Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # Build e Deploy Staging
  build-staging:
    name: ğŸš€ Build e Deploy Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        npm ci
        
    - name: ğŸ§ª Run integration tests
      run: |
        npm run test:integration
        python -m pytest tests/integration/ -v
        
    - name: ğŸ³ Build Docker images
      run: |
        docker build -f deploy/staging/Dockerfile.frontend -t aeon-chess-frontend:staging .
        docker build -f deploy/staging/Dockerfile.backend -t aeon-chess-backend:staging .
        
    - name: ğŸš€ Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Aqui vocÃª pode adicionar comandos para deploy em staging
        # Por exemplo: kubectl apply, docker-compose up, etc.

  # Build e Deploy Production
  build-production:
    name: ğŸš€ Build e Deploy Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        npm ci
        
    - name: ğŸ§ª Run production tests
      run: |
        npm run test:production
        python -m pytest tests/production/ -v
        
    - name: ğŸ”’ Security scan
      run: |
        npm audit --audit-level=moderate
        safety check
        
    - name: ğŸ³ Build production Docker images
      run: |
        docker build -f deploy/production/Dockerfile.frontend -t aeon-chess-frontend:latest .
        docker build -f deploy/production/Dockerfile.backend -t aeon-chess-backend:latest .
        
    - name: ğŸš€ Deploy to production
      run: |
        echo "Deploying to production environment..."
        # Aqui vocÃª pode adicionar comandos para deploy em produÃ§Ã£o
        # Por exemplo: kubectl apply, docker-compose up, etc.

  # Performance Testing
  performance:
    name: ğŸ“Š Performance Testing
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸš€ Start application
      run: |
        npm run build
        npm start &
        sleep 30
        
    - name: ğŸ“Š Run Lighthouse CI
      run: |
        npm install -g @lhci/cli
        lhci autorun
        
    - name: ğŸ“Š Upload Lighthouse results
      uses: actions/upload-artifact@v3
      with:
        name: lighthouse-results
        path: .lighthouseci/

  # Security Scanning
  security:
    name: ğŸ›¡ï¸ Security Scanning
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
    - name: ğŸ”’ Run Bandit security scan
      run: |
        pip install bandit
        bandit -r src/ -f json -o bandit-report.json
        
    - name: ğŸ“Š Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          snyk-report.json
