# AWS CloudFront CDN Configuration for Aeon Chess
# This configuration optimizes content delivery globally

AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFront CDN Distribution for Aeon Chess'

Parameters:
  DomainName:
    Type: String
    Default: 'aeonchess.com'
    Description: 'Primary domain name'
  
  CertificateArn:
    Type: String
    Description: 'ARN of the SSL certificate in ACM'
  
  OriginDomainName:
    Type: String
    Default: 'aeonchess.com'
    Description: 'Origin domain for the distribution'

Resources:
  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: 'Aeon Chess CDN Distribution'
        Enabled: true
        DefaultRootObject: 'index.html'
        
        # Origins
        Origins:
          - Id: 'FrontendOrigin'
            DomainName: !Ref OriginDomainName
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: 'https-only'
              OriginSSLProtocols: ['TLSv1.2', 'TLSv1.3']
            CustomHeaders:
              - HeaderName: 'X-Origin-Environment'
                HeaderValue: 'production'
          
          - Id: 'APIOrigin'
            DomainName: 'api.aeonchess.com'
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: 'https-only'
              OriginSSLProtocols: ['TLSv1.2', 'TLSv1.3']
            CustomHeaders:
              - HeaderName: 'X-Origin-Environment'
                HeaderValue: 'production'
          
          - Id: 'StaticAssetsOrigin'
            DomainName: 'static.aeonchess.com'
            S3OriginConfig:
              OriginAccessIdentity: !Ref CloudFrontOriginAccessIdentity
            CustomHeaders:
              - HeaderName: 'X-Origin-Environment'
                HeaderValue: 'production'
        
        # Default Cache Behavior
        DefaultCacheBehavior:
          TargetOriginId: 'FrontendOrigin'
          ViewerProtocolPolicy: 'redirect-to-https'
          AllowedMethods: ['GET', 'HEAD', 'OPTIONS']
          CachedMethods: ['GET', 'HEAD']
          Compress: true
          
          # Cache Policy
          CachePolicyId: '4135ea2d-6df8-44a3-9df3-4b5a84be39ad' # Managed-CachingOptimized
          
          # Origin Request Policy
          OriginRequestPolicyId: 'b689b0a8-53d0-40ab-baf2-68738e2966ac' # Managed-CORS-S3Origin
          
          # Response Headers Policy
          ResponseHeadersPolicyId: '67f7725c-6f97-4210-82d7-5512b31e9d03' # Managed-SecurityHeadersPolicy
        
        # Cache Behaviors for Different Content Types
        CacheBehaviors:
          # API Routes
          - PathPattern: '/api/*'
            TargetOriginId: 'APIOrigin'
            ViewerProtocolPolicy: 'redirect-to-https'
            AllowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'HEAD', 'OPTIONS']
            CachedMethods: ['GET', 'HEAD']
            Compress: true
            CachePolicyId: '4135ea2d-6df8-44a3-9df3-4b5a84be39ad'
            OriginRequestPolicyId: 'b689b0a8-53d0-40ab-baf2-68738e2966ac'
            ResponseHeadersPolicyId: '67f7725c-6f97-4210-82d7-5512b31e9d03'
          
          # Static Assets
          - PathPattern: '/static/*'
            TargetOriginId: 'StaticAssetsOrigin'
            ViewerProtocolPolicy: 'redirect-to-https'
            AllowedMethods: ['GET', 'HEAD', 'OPTIONS']
            CachedMethods: ['GET', 'HEAD']
            Compress: true
            CachePolicyId: '658327ea-f89d-4fab-a63d-7e886ee39dcf' # Managed-CachingDisabled
            OriginRequestPolicyId: 'b689b0a8-53d0-40ab-baf2-68738e2966ac'
            ResponseHeadersPolicyId: '67f7725c-6f97-4210-82d7-5512b31e9d03'
          
          # Images
          - PathPattern: '/images/*'
            TargetOriginId: 'StaticAssetsOrigin'
            ViewerProtocolPolicy: 'redirect-to-https'
            AllowedMethods: ['GET', 'HEAD', 'OPTIONS']
            CachedMethods: ['GET', 'HEAD']
            Compress: true
            CachePolicyId: '4135ea2d-6df8-44a3-9df3-4b5a84be39ad'
            OriginRequestPolicyId: 'b689b0a8-53d0-40ab-baf2-68738e2966ac'
            ResponseHeadersPolicyId: '67f7725c-6f97-4210-82d7-5512b31e9d03'
          
          # JavaScript and CSS
          - PathPattern: '/*.js'
            TargetOriginId: 'StaticAssetsOrigin'
            ViewerProtocolPolicy: 'redirect-to-https'
            AllowedMethods: ['GET', 'HEAD', 'OPTIONS']
            CachedMethods: ['GET', 'HEAD']
            Compress: true
            CachePolicyId: '4135ea2d-6df8-44a3-9df3-4b5a84be39ad'
            OriginRequestPolicyId: 'b689b0a8-53d0-40ab-baf2-68738e2966ac'
            ResponseHeadersPolicyId: '67f7725c-6f97-4210-82d7-5512b31e9d03'
          
          - PathPattern: '/*.css'
            TargetOriginId: 'StaticAssetsOrigin'
            ViewerProtocolPolicy: 'redirect-to-https'
            AllowedMethods: ['GET', 'HEAD', 'OPTIONS']
            CachedMethods: ['GET', 'HEAD']
            Compress: true
            CachePolicyId: '4135ea2d-6df8-44a3-9df3-4b5a84be39ad'
            OriginRequestPolicyId: 'b689b0a8-53d0-40ab-baf2-68738e2966ac'
            ResponseHeadersPolicyId: '67f7725c-6f97-4210-82d7-5512b31e9d03'
        
        # Aliases
        Aliases:
          - !Ref DomainName
          - "www.${DomainName}"
          - "api.${DomainName}"
          - "static.${DomainName}"
        
        # SSL Certificate
        ViewerCertificate:
          AcmCertificateArn: !Ref CertificateArn
          SslSupportMethod: 'sni-only'
          MinimumProtocolVersion: 'TLSv1.2_2021'
        
        # Error Pages
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: '200'
            ResponsePagePath: '/index.html'
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: '200'
            ResponsePagePath: '/index.html'
            ErrorCachingMinTTL: 300
        
        # Price Class
        PriceClass: 'PriceClass_100' # Use only North America and Europe
        
        # Logging
        Logging:
          Bucket: !Sub '${DomainName}-cloudfront-logs.s3.amazonaws.com'
          IncludeCookies: false
          Prefix: 'cloudfront/'
        
        # Web ACL (Security)
        WebACLId: !Ref CloudFrontWebACL
        
        # Default Root Object
        DefaultRootObject: 'index.html'
        
        # HTTP Version
        HttpVersion: 'http2'
        
        # IPV6
        IPV6Enabled: true

  # CloudFront Origin Access Identity
  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: 'OAI for Aeon Chess Static Assets'

  # WAF Web ACL for Security
  CloudFrontWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: 'aeon-chess-web-acl'
      Description: 'Web ACL for Aeon Chess CloudFront distribution'
      Scope: 'CLOUDFRONT'
      DefaultAction:
        Allow: {}
      Rules:
        # Rate Limiting Rule
        - Name: 'RateLimitRule'
          Priority: 1
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: 'IP'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'RateLimitRule'
        
        # SQL Injection Rule
        - Name: 'SQLInjectionRule'
          Priority: 2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesSQLiRuleSet'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'SQLInjectionRule'
        
        # XSS Rule
        - Name: 'XSSRule'
          Priority: 3
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesKnownBadInputsRuleSet'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'XSSRule'
        
        # Bad Bot Rule
        - Name: 'BadBotRule'
          Priority: 4
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesBotControlRuleSet'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'BadBotRule'
      
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: 'AeonChessWebACL'

Outputs:
  CloudFrontDistributionId:
    Description: 'CloudFront Distribution ID'
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub '${AWS::StackName}-DistributionId'
  
  CloudFrontDomainName:
    Description: 'CloudFront Distribution Domain Name'
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub '${AWS::StackName}-DomainName'
  
  CloudFrontOriginAccessIdentity:
    Description: 'CloudFront Origin Access Identity'
    Value: !Ref CloudFrontOriginAccessIdentity
    Export:
      Name: !Sub '${AWS::StackName}-OAI'
