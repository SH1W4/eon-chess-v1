# AWS CloudFront CDN Configuration for Aeon Chess
# This configuration optimizes content delivery globally

AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFront CDN Configuration for AEON Chess'

Parameters:
  DomainName:
    Type: String
    Default: 'aeonchess.com'
    Description: 'Primary domain name'
  
  CertificateArn:
    Type: String
    Description: 'ARN of the SSL certificate in ACM'
  
  OriginDomainName:
    Type: String
    Default: 'aeonchess.com'
    Description: 'Origin domain name for the application'

Resources:
  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: 'AEON Chess CDN Distribution'
        Enabled: true
        DefaultRootObject: index.html
        
        # Origins
        Origins:
          - Id: 'FrontendOrigin'
            DomainName: !Ref OriginDomainName
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: 'https-only'
              OriginSSLProtocols: ['TLSv1.2']
          
          - Id: 'APIOrigin'
            DomainName: !Sub 'api.${DomainName}'
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: 'https-only'
              OriginSSLProtocols: ['TLSv1.2']
          
          - Id: 'StaticAssetsOrigin'
            DomainName: !Sub 'static.${DomainName}'
            S3OriginConfig:
              OriginAccessIdentity: !Ref CloudFrontOriginAccessIdentity
        
        # Default Cache Behavior
        DefaultCacheBehavior:
          TargetOriginId: 'FrontendOrigin'
          ViewerProtocolPolicy: 'redirect-to-https'
          AllowedMethods: ['GET', 'HEAD', 'OPTIONS']
          CachedMethods: ['GET', 'HEAD']
          Compress: true
          
          # Cache Settings
          MinTTL: 0
          DefaultTTL: 86400  # 24 hours
          MaxTTL: 31536000   # 1 year
          
          # Headers to cache
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: 'none'
            Headers:
              - 'Accept'
              - 'Accept-Language'
              - 'Accept-Encoding'
              - 'User-Agent'
              - 'Referer'
        
        # API Cache Behavior
        CacheBehaviors:
          - PathPattern: '/api/*'
            TargetOriginId: 'APIOrigin'
            ViewerProtocolPolicy: 'redirect-to-https'
            AllowedMethods: ['GET', 'HEAD', 'POST', 'PUT', 'DELETE', 'OPTIONS']
            CachedMethods: ['GET', 'HEAD']
            Compress: true
            
            # API specific cache settings
            MinTTL: 0
            DefaultTTL: 300    # 5 minutes
            MaxTTL: 3600       # 1 hour
            
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: 'all'
              Headers:
                - 'Authorization'
                - 'Content-Type'
                - 'Accept'
                - 'User-Agent'
          
          - PathPattern: '/_next/*'
            TargetOriginId: 'StaticAssetsOrigin'
            ViewerProtocolPolicy: 'redirect-to-https'
            AllowedMethods: ['GET', 'HEAD', 'OPTIONS']
            CachedMethods: ['GET', 'HEAD']
            Compress: true
            
            # Static assets cache settings
            MinTTL: 0
            DefaultTTL: 31536000  # 1 year
            MaxTTL: 31536000      # 1 year
            
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: 'none'
              Headers:
                - 'Accept'
                - 'Accept-Language'
                - 'Accept-Encoding'
                - 'User-Agent'
        
        # Custom Error Responses
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: '200'
            ResponsePagePath: '/index.html'
            ErrorCachingMinTTL: 300
          
          - ErrorCode: 403
            ResponseCode: '200'
            ResponsePagePath: '/index.html'
            ErrorCachingMinTTL: 300
        
        # SSL Configuration
        ViewerCertificate:
          AcmCertificateArn: !Ref CertificateArn
          SslSupportMethod: 'sni-only'
          MinimumProtocolVersion: 'TLSv1.2_2021'
        
        # Price Class
        PriceClass: 'PriceClass_100'  # Use only North America and Europe
        
        # Logging
        Logging:
          Bucket: !Sub '${DomainName}-logs.s3.amazonaws.com'
          Prefix: 'cloudfront/'
          IncludeCookies: false
        
        # Web ACL
        WebACLId: !Ref CloudFrontWebACL

  # CloudFront Origin Access Identity
  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: 'OAI for AEON Chess S3 bucket access'

  # WAF Web ACL
  CloudFrontWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: 'AEON-Chess-WebACL'
      Description: 'WAF Web ACL for AEON Chess CDN'
      Scope: 'CLOUDFRONT'
      DefaultAction:
        Allow: {}
      
      Rules:
        # Rate Limiting Rule
        - Name: 'RateLimitRule'
          Priority: 1
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: 'IP'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'RateLimitRule'
        
        # SQL Injection Protection
        - Name: 'SQLInjectionRule'
          Priority: 2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesSQLiRuleSet'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'SQLInjectionRule'
        
        # XSS Protection
        - Name: 'XSSRule'
          Priority: 3
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesKnownBadInputsRuleSet'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'XSSRule'
        
        # Bot Control
        - Name: 'BotControlRule'
          Priority: 4
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesBotControlRuleSet'
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'BotControlRule'
      
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: 'AEONChessWebACL'

Outputs:
  DistributionId:
    Description: 'CloudFront Distribution ID'
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub '${AWS::StackName}-DistributionId'
  
  DistributionDomainName:
    Description: 'CloudFront Distribution Domain Name'
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub '${AWS::StackName}-DistributionDomainName'
  
  OriginAccessIdentity:
    Description: 'CloudFront Origin Access Identity'
    Value: !Ref CloudFrontOriginAccessIdentity
    Export:
      Name: !Sub '${AWS::StackName}-OriginAccessIdentity'
